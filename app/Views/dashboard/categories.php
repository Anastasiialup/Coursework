<?php
require_once __DIR__ . '/../../Models/Category.php';
require_once __DIR__ . '/../../Controllers/CategoryController.php';
require_once __DIR__ . '/../../../config/database.php';

use app\Models\Category;
use app\Controllers\CategoryController;

// –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ —î —Å–µ—Å—ñ—è –∑ user_id
session_start();
if (!isset($_SESSION['user_id'])) {
    // –Ø–∫—â–æ user_id –Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–æ —É —Å–µ—Å—ñ—ó, –º–æ–∂–ª–∏–≤–æ, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ —É–≤—ñ–π—à–æ–≤ —É —Å–∏—Å—Ç–µ–º—É, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤—Ç–µ –π–æ–≥–æ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –≤—Ö–æ–¥—É
    header("Location: ../profile/profile.php");
    exit;
}

// –û–±—Ä–æ–±–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $categoryName = $_POST["category_name"];
    $categoryType = $_POST["category_type"];
    $categoryColor = $_POST["category_color"];
    $user_id = $_SESSION['user_id']; // –ü—Ä–∏–ø—É—Å–∫–∞—î—Ç—å—Å—è, —â–æ –º–∏ –º–∞—î–º–æ user_id —É —Å–µ—Å—ñ—ó

    // –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–ª–∞—Å—É Category
    Category::add($conn, $categoryName, $categoryType, $categoryColor, $user_id);
}

// –í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ ID —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä "delete_category"
if (isset($_GET["delete_category"])) {
    $categoryId = $_GET["delete_category"];

    // –í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–ª–∞—Å—É Category
    Category::delete($conn, $categoryId);
}

// –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –∑ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
$user_id = $_SESSION['user_id']; // –ü—Ä–∏–ø—É—Å–∫–∞—î—Ç—å—Å—è, —â–æ –º–∏ –º–∞—î–º–æ user_id —É —Å–µ—Å—ñ—ó
$categories = Category::getAll($conn, $user_id);
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Categories</title>
    <link rel="stylesheet" href="../../../public/css/categories.css">
</head>
<body>
<?php include('../partials/header.php'); ?>
<main>
    <div class="search-container">
        <label for="search-filter">–ü–æ—à—É–∫ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π:</label>
        <input type="text" id="searchInput" onkeyup="search()" placeholder="–ü–æ—à—É–∫ –∑–∞ –Ω–∞–∑–≤–æ—é...">
        <button onclick="search()">–ü–æ—à—É–∫</button>
    </div>
    <table id="categories-table">
        <thead>
        <tr>
            <th onclick="sortTable(0)">–ù–∞–∑–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó<span class="filter-icon" onclick="toggleFilter(0)">üîç</span></th>
            <th onclick="sortTable(1)">–¢–∏–ø –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó<span class="filter-icon" onclick="toggleFilter(1)">üîç</span></th>
            <th>–ö–æ–ª—ñ—Ä</th>
            <th>–î—ñ—ó</th>
        </tr>
        </thead>
        <tbody id="category-list">
        <?php foreach ($categories as $category): ?>
            <tr>
                <td><?php echo $category['name']; ?></td>
                <td><?php echo $category['type']; ?></td>
                <td><span class="category-color-box" style="background-color: <?php echo $category['color']; ?>"></span></td>
                <td><a href="?delete_category=<?php echo $category['id']; ?>">–í–∏–¥–∞–ª–∏—Ç–∏</a></td>
            </tr>
        <?php endforeach; ?>
        </tbody>
    </table>
    <form class="add-category-form" method="post">
        <label for="category-name">–ù–∞–∑–≤–∞ –Ω–æ–≤–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ó:</label>
        <input type="text" id="category-name" name="category_name" required>
        <label for="category-type">–¢–∏–ø –Ω–æ–≤–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó:</label>
        <select id="category-type" name="category_type" required>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
        </select>
        <label for="category-color">–ö–æ–ª—ñ—Ä –Ω–æ–≤–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó:</label>
        <input type="color" id="category-color" name="category_color" required>
        <button type="submit">–î–æ–¥–∞—Ç–∏ –Ω–æ–≤—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</button>
    </form>
</main>

<?php include('../partials/footer.php'); ?>

<script src="../../../public/js/categories.js" defer></script>
<script>
    function search() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("searchInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("categories-table");
        tr = table.getElementsByTagName("tr");
        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[0]; // –û—Ç—Ä–∏–º—É—î–º–æ –ø–µ—Ä—à–∏–π <td> —É –∫–æ–∂–Ω–æ–º—É —Ä—è–¥–∫—É
            if (td) {
                txtValue = td.textContent || td.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>
</body>
</html>
